<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Chatbot Lnnz</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col h-screen transition-colors">

<div id="chatContainer" class="flex-1 flex flex-col max-w-md mx-auto mt-5 bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden resize-x">
    <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>

    <div id="quickReplies" class="flex gap-2 p-2 overflow-x-auto"></div>

    <div class="flex border-t border-gray-300 dark:border-gray-700 p-2">
        <textarea id="userInput" placeholder="Tulis pesan..." class="flex-1 px-4 py-2 rounded-l-xl border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 rounded-r-xl hover:bg-blue-600">Kirim</button>
    </div>
</div>

<footer class="text-center text-gray-400 dark:text-gray-500 text-xs mt-2">Lnnzphry || 2025</footer>

<script>
const personas = ["Friendly","Formal","Fun"];
let currentPersona = "Friendly";
const quickReplies = ["Halo","Bantuan","Jadwal"];
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('userInput');
const quickEl = document.getElementById('quickReplies');

// Quick replies
quickReplies.forEach(q=>{
    const btn = document.createElement('button');
    btn.innerText = q;
    btn.className="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600";
    btn.onclick=()=>{inputEl.value=q;sendMessage();};
    quickEl.appendChild(btn);
});

// Load chat history
const history = JSON.parse(localStorage.getItem('chatHistory')||'[]');
history.forEach(msg=>addMessage(msg.text,msg.sender));

// Send message
async function sendMessage(){
    const text = inputEl.value.trim();
    if(!text) return;
    if(text==="/clear"){localStorage.removeItem('chatHistory');messagesEl.innerHTML="";inputEl.value="";return;}

    addMessage(text,'user',true);
    saveHistory(text,'user');
    inputEl.value="";

    const typingEl = addMessage("Bot sedang mengetik...",'bot',true);

    try{
        const response = await fetch('/api/chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({prompt:text, persona: currentPersona})
        });
        const data = await response.json();
        typingEl.remove();
        addMessage(data.reply||"Bot tidak merespon",'bot');
        saveHistory(data.reply||"Bot tidak merespon",'bot');
    }catch(e){
        typingEl.remove();
        addMessage("Error: Tidak bisa terhubung ke server",'bot');
        saveHistory("Error: Tidak bisa terhubung ke server",'bot');
    }
}

// Add message helper
function addMessage(text,sender,isTyping=false){
    const msg=document.createElement('div');
    msg.className=`flex px-4 py-2 max-w-[80%] rounded-2xl ${sender==='user'?'bg-blue-500 text-white self-end rounded-br-none animate-slideInRight':'bg-gray-200 text-black dark:bg-gray-700 dark:text-white self-start rounded-bl-none animate-slideInLeft'} ${isTyping?'italic opacity-70':''}`;
    msg.innerHTML=text;
    messagesEl.appendChild(msg);
    messagesEl.scrollTop=messagesEl.scrollHeight;
    return isTyping?msg:null;
}

// Save chat history
function saveHistory(text,sender){
    const h=JSON.parse(localStorage.getItem('chatHistory')||'[]');
    h.push({text,sender});
    localStorage.setItem('chatHistory',JSON.stringify(h));
}

// Multi-line input
inputEl.addEventListener('keydown',function(e){
    if(e.key==='Enter' && !e.shiftKey){e.preventDefault();sendMessage();}
});

// Dark/Light mode auto
if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}
else{document.body.classList.remove('dark');}
</script>
</body>
</html>